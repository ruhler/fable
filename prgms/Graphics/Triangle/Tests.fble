
@ Drawing@ = /Drawing%.Drawing@;
% Color = /Drawing%.Color;

@ Drawn@ = /Drawing/Test%.Drawn@;
@ Pixel@ = /Drawing/Test%.Pixel@;
% Drawn = /Drawing/Test%.Drawn;
% Draw = /Drawing/Test%.Draw;

@ Vec@ = /Graphics/3D%.Vec@;

@ Camera@ = /Graphics/Camera%.Camera@;
@ Rect@ = /Graphics/Camera%.Rect@;
% Camera = /Graphics/Camera%.Camera;
% RotateY = /Graphics/Camera%.RotateY;
% Translate = /Graphics/Camera%.Translate;
% Vertex = /Graphics/Camera%.Vertex;

% Triangle = /Graphics/Triangle%.Triangle;

% Neg = /Int/Int%.Neg;
% Int = /Int/Int/Lit%.Int;

<@>% List = /List%.List;

% Str = /String%.Str;

@ Test@ = /Test%.Test@;
% Test = /Test%.Test;
% TestSuite = /Test%.TestSuite;

Test@ Tests = TestSuite(Str|'Graphics.Triangle', List<Test@>[
  Test(Str|'Focus Triangle', !({
    # A triangle drawn at the focus plane should appear normal size.
    Camera@ camera = Camera(Int|10, Rect@(Neg(Int|1), Neg(Int|1), Int|6, Int|6));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|10));
    Vec@ b = Vertex(camera, Vec@(Int|0, Int|4, Int|10));
    Vec@ c = Vertex(camera, Vec@(Int|4, Int|0, Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|0, Int|3, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green),
      Pixel@(Int|2, Int|0, Color.Green),
      Pixel@(Int|2, Int|1, Color.Green),
      Pixel@(Int|3, Int|0, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'Far Triangle', !({
    # A triangle drawn at twice the distance from the focus plane should
    # appear half its actual size.
    Camera@ camera = Camera(Int|10, Rect@(Neg(Int|1), Neg(Int|1), Int|6, Int|6));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|20));
    Vec@ b = Vertex(camera, Vec@(Int|0, Int|4, Int|20));
    Vec@ c = Vertex(camera, Vec@(Int|4, Int|0, Int|20));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'Close Triangle', !({
    # A triangle drawn at half the distance to the focus plane should appear
    # twice its normal size.
    Camera@ camera = Camera(Int|10, Rect@(Neg(Int|1), Neg(Int|1), Int|6, Int|6));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|5));
    Vec@ b = Vertex(camera, Vec@(Int|0, Int|2, Int|5));
    Vec@ c = Vertex(camera, Vec@(Int|2, Int|0, Int|5));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|0, Int|3, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green),
      Pixel@(Int|2, Int|0, Color.Green),
      Pixel@(Int|2, Int|1, Color.Green),
      Pixel@(Int|3, Int|0, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'Translated Triangle', !({
    # Test that translation moves the camera in the direction specified.
    Camera@ camera = Translate(Int|0, Int|0, Int|10,
      Camera(Int|10, Rect@(Neg(Int|1), Neg(Int|1), Int|6, Int|6)));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|20));
    Vec@ b = Vertex(camera, Vec@(Int|0, Int|4, Int|20));
    Vec@ c = Vertex(camera, Vec@(Int|4, Int|0, Int|20));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|0, Int|3, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green),
      Pixel@(Int|2, Int|0, Color.Green),
      Pixel@(Int|2, Int|1, Color.Green),
      Pixel@(Int|3, Int|0, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'Rotated Triangle', !({
    # Test that rotation rotates the camera in the direction specified.
    # Here we rotate the camera 90 degrees around the Y axis, so that the
    # camera is now looking in the -x direction.
    Camera@ camera = RotateY(Int|64,
      Camera(Int|10, Rect@(Neg(Int|1), Neg(Int|1), Int|6, Int|6)));
    Vec@ a = Vertex(camera, Vec@(Neg(Int|10), Int|0, Int|0));
    Vec@ b = Vertex(camera, Vec@(Neg(Int|10), Int|4, Int|0));
    Vec@ c = Vertex(camera, Vec@(Neg(Int|10), Int|0, Int|4));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|0, Int|3, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green),
      Pixel@(Int|2, Int|0, Color.Green),
      Pixel@(Int|2, Int|1, Color.Green),
      Pixel@(Int|3, Int|0, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'1 Vertex Clip Right', !({
    # One of the vertices of the triangle is clipped, so that the result of
    # drawing a triangle looks like a trapezoid.
    Camera@ camera = Camera(Int|10, Rect@(Int|0, Int|0, Int|2, Int|8));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|10));
    Vec@ b = Vertex(camera, Vec@(Int|0, Int|4, Int|10));
    Vec@ c = Vertex(camera, Vec@(Int|4, Int|0, Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|0, Int|3, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'2 Vertex Clip Right', !({
    # Two of the verticies of the triangle are clipped, so that the result of
    # drawing a triangle looks like a smaller triangle.
    Camera@ camera = Camera(Int|10, Rect@(Int|0, Int|0, Int|2, Int|8));
    Vec@ a = Vertex(camera, Vec@(Int|0, Int|0, Int|10));
    Vec@ b = Vertex(camera, Vec@(Int|4, Int|4, Int|10));
    Vec@ c = Vertex(camera, Vec@(Int|4, Int|0, Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'3 Vertex Clip Right', !({
    # The entire triangle is outside the clipping region, so nothing should be
    # drawn.
    Camera@ camera = Camera(Int|10, Rect@(Int|0, Int|0, Int|8, Int|8));
    Vec@ a = Vertex(camera, Vec@(Int|10, Int|10, Int|10));
    Vec@ b = Vertex(camera, Vec@(Int|10, Int|14, Int|10));
    Vec@ c = Vertex(camera, Vec@(Int|14, Int|10, Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'1 Vertex Clip Left', !({
    # One of the verticies of the triangle is clipped on the left.
    Camera@ camera = Camera(Int|10, Rect@(Int|0, Int|0, Int|2, Int|8));
    Vec@ a = Vertex(camera, Vec@(Neg(Int|2), Int|0, Int|10));
    Vec@ b = Vertex(camera, Vec@(Int|2, Int|4, Int|10));
    Vec@ c = Vertex(camera, Vec@(Int|2, Int|0, Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|0, Int|2, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green),
      Pixel@(Int|1, Int|2, Color.Green),
      Pixel@(Int|1, Int|3, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  })),

  Test(Str|'Full Screen Clipped Triangle', !({
    # The triangle takes up the entire available display, so you see a solid
    # color screen. Tests clipping on all sides.
    Camera@ camera = Camera(Int|10, Rect@(Int|0, Int|0, Int|2, Int|2));
    Vec@ a = Vertex(camera, Vec@(Neg(Int|3), Neg(Int|1), Int|10));
    Vec@ b = Vertex(camera, Vec@(    Int|3,      Int|5 , Int|10));
    Vec@ c = Vertex(camera, Vec@(    Int|3,  Neg(Int|1), Int|10));

    Drawing@ drawing = Triangle(camera, a, b, c, Color.Green);

    Drawn@ wnt = Drawn[
      Pixel@(Int|0, Int|0, Color.Green),
      Pixel@(Int|0, Int|1, Color.Green),
      Pixel@(Int|1, Int|0, Color.Green),
      Pixel@(Int|1, Int|1, Color.Green)
    ];
    Drawn@ got = Draw(drawing);
      
    /Drawing/Test%.AssertEquals(wnt, got);
  }))

  # TODO:
  # * Add test for clipping where two vertices are outside the clip region
  #   but the line between them has parts inside the clip region?
  # * Add tests for clipping due to point behind the camera.
]);

 @(Tests);
