module Md5TestM(Md5TestI) {
  import @ { UnitM; BoolM; Bit8M; HexM; ListM; MaybeM; Md5M; };
  import UnitM { Unit; };
  import Bit8M { Bit8; H2; };
  import HexM { Hex; 0; 1; 2; 3; 4; 5; 6; 7; 8; 9; a; b; c; d; e; f; };
  import ListM { P; S; };
  import MaybeM { Maybe; };
  import Md5M { Md5Hash; Md5; Eq; };

  union TestName(
      Unit Md5_empty,
      Unit Md5_a,
      Unit Md5_abc,
      Unit Md5_message,
      Unit Md5_a_to_z,
      Unit Md5_A_to_9,
      Unit Md5_1_to_0
  );

  struct TestFailure(TestName name, Md5Hash wnt, Md5Hash got);

  # Compute the md5 hash for a string of bytes.
  priv proc Md5Str(; S<Bit8> bytes; Md5Hash) {
    Maybe<Bit8> +- put, get;
    Md5Hash md5 = Md5(get; ), Unit x = PutAll(put; bytes);
    $(md5);
  };
  
  # Put all the bytes onto the output port, followed by nothing.
  priv proc PutAll(Maybe<Bit8>+ out; S<Bit8> bytes; Unit) {
    ?(bytes; {
        Maybe<Bit8> x = +out(Maybe<Bit8>:just(bytes.cons.head));
        PutAll(out; bytes.cons.tail);
      }, {
        Maybe<Bit8> x = +out(Maybe<Bit8>:nothing(Unit()));
        $(Unit());
    });
  };

  priv proc TestStr( ; TestName name, Md5Hash wnt, S<Bit8> bytes; TestFailure) {
    Md5Hash got = Md5Str( ; bytes);
    $(TestFailure(name, wnt, got));
  };

  priv func L(Hex hi, Hex lo, S<Bit8> l; S<Bit8>) {
    S<Bit8>:cons(P<Bit8>(H2(hi, lo), l));
  };

  priv func T(TestFailure x, S<TestFailure> l; S<TestFailure>) {
    ?(Eq(x.wnt, x.got); l, S<TestFailure>:cons(P<TestFailure>(x, l)));
  };

  proc Test( ; ; S<TestFailure>) {
    TestFailure empty = TestStr( ; 
      TestName:Md5_empty(Unit()),
      Md5Hash(
        d(), 4(), 1(), d(), 8(), c(), d(), 9(),
        8(), f(), 0(), 0(), b(), 2(), 0(), 4(),
        e(), 9(), 8(), 0(), 0(), 9(), 9(), 8(),
        e(), c(), f(), 8(), 4(), 2(), 7(), e()),
      S<Bit8>:nil(Unit())
    );

    TestFailure a = TestStr( ;
      TestName:Md5_a(Unit()),
      Md5Hash(
        0(), c(), c(), 1(), 7(), 5(), b(), 9(),
        c(), 0(), f(), 1(), b(), 6(), a(), 8(),
        3(), 1(), c(), 3(), 9(), 9(), e(), 2(),
        6(), 9(), 7(), 7(), 2(), 6(), 6(), 1()),
      L(6(), 1(), # 'a'
        S<Bit8>:nil(Unit()))
    );

    TestFailure abc = TestStr( ;
      TestName:Md5_abc(Unit()),
      Md5Hash(
        9(), 0(), 0(), 1(), 5(), 0(), 9(), 8(),
        3(), c(), d(), 2(), 4(), f(), b(), 0(),
        d(), 6(), 9(), 6(), 3(), f(), 7(), d(),
        2(), 8(), e(), 1(), 7(), f(), 7(), 2()),
        # "abc"
      L(6(), 1(), L(6(), 2(), L(6(), 3(),
        S<Bit8>:nil(Unit()))))
    );

    TestFailure message = TestStr( ;
      TestName:Md5_message(Unit()),
      Md5Hash(
        f(), 9(), 6(), b(), 6(), 9(), 7(), d(),
        7(), c(), b(), 7(), 9(), 3(), 8(), d(),
        5(), 2(), 5(), a(), 2(), f(), 3(), 1(),
        a(), a(), f(), 1(), 6(), 1(), d(), 0()), 
        # "message digest"
      L(6(), d(), L(6(), 5(), L(7(), 3(), L(7(), 3(),
      L(6(), 1(), L(6(), 7(), L(6(), 5(), L(2(), 0(),
      L(6(), 4(), L(6(), 9(), L(6(), 7(), L(6(), 5(),
      L(7(), 3(), L(7(), 4(),
        S<Bit8>:nil(Unit())))))))))))))))
    );

    TestFailure a_to_z = TestStr( ;
      TestName:Md5_a_to_z(Unit()),
      Md5Hash(
        c(), 3(), f(), c(), d(), 3(), d(), 7(),
        6(), 1(), 9(), 2(), e(), 4(), 0(), 0(),
        7(), d(), f(), b(), 4(), 9(), 6(), c(),
        c(), a(), 6(), 7(), e(), 1(), 3(), b()),
        # "abcdefghijklmnopqrstuvwxyz"
      L(6(), 1(), L(6(), 2(), L(6(), 3(), L(6(), 4(),
      L(6(), 5(), L(6(), 6(), L(6(), 7(), L(6(), 8(),
      L(6(), 9(), L(6(), a(), L(6(), b(), L(6(), c(),
      L(6(), d(), L(6(), e(), L(6(), f(), L(7(), 0(),
      L(7(), 1(), L(7(), 2(), L(7(), 3(), L(7(), 4(),
      L(7(), 5(), L(7(), 6(), L(7(), 7(), L(7(), 8(),
      L(7(), 9(), L(7(), a(),
        S<Bit8>:nil(Unit())))))))))))))))))))))))))))
    );

    TestFailure A_to_9 = TestStr( ;
      TestName:Md5_A_to_9(Unit()),
      Md5Hash(
        d(), 1(), 7(), 4(), a(), b(), 9(), 8(),
        d(), 2(), 7(), 7(), d(), 9(), f(), 5(),
        a(), 5(), 6(), 1(), 1(), c(), 2(), c(),
        9(), f(), 4(), 1(), 9(), d(), 9(), f()),
        # "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
      L(4(), 1(), L(4(), 2(), L(4(), 3(), L(4(), 4(),
      L(4(), 5(), L(4(), 6(), L(4(), 7(), L(4(), 8(),
      L(4(), 9(), L(4(), a(), L(4(), b(), L(4(), c(),
      L(4(), d(), L(4(), e(), L(4(), f(), L(5(), 0(),
      L(5(), 1(), L(5(), 2(), L(5(), 3(), L(5(), 4(),
      L(5(), 5(), L(5(), 6(), L(5(), 7(), L(5(), 8(),
      L(5(), 9(), L(5(), a(),
      L(6(), 1(), L(6(), 2(), L(6(), 3(), L(6(), 4(),
      L(6(), 5(), L(6(), 6(), L(6(), 7(), L(6(), 8(),
      L(6(), 9(), L(6(), a(), L(6(), b(), L(6(), c(),
      L(6(), d(), L(6(), e(), L(6(), f(), L(7(), 0(),
      L(7(), 1(), L(7(), 2(), L(7(), 3(), L(7(), 4(),
      L(7(), 5(), L(7(), 6(), L(7(), 7(), L(7(), 8(),
      L(7(), 9(), L(7(), a(),
      L(3(), 0(), L(3(), 1(), L(3(), 2(), L(3(), 3(),
      L(3(), 4(), L(3(), 5(), L(3(), 6(), L(3(), 7(),
      L(3(), 8(), L(3(), 9(),
        S<Bit8>:nil(Unit())))))))))))
    )))))))))))))))))))))))))))))))))))))))))))))))))))));

    TestFailure 1_to_0 = TestStr( ;
      TestName:Md5_1_to_0(Unit()),
      Md5Hash(
        5(), 7(), e(), d(), f(), 4(), a(), 2(),
        2(), b(), e(), 3(), c(), 9(), 5(), 5(),
        a(), c(), 4(), 9(), d(), a(), 2(), e(),
        2(), 1(), 0(), 7(), b(), 6(), 7(), a()),
        # "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
      L(3(), 1(), L(3(), 2(), L(3(), 3(), L(3(), 4(),
      L(3(), 5(), L(3(), 6(), L(3(), 7(), L(3(), 8(),
      L(3(), 9(), L(3(), 0(),
        S<Bit8>:nil(Unit())))))))))))))))
          )))))))))))))))))))))))))))))))
    ))))))))))))))))))))))))))))))))))));

    $(T(empty, T(a, T(abc, T(message, T(a_to_z, T(A_to_9, T(1_to_0,
        S<TestFailure>:nil(Unit())))))))));
  };
};
