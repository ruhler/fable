
rule cc
  description = cc $in
  deps = gcc
  depfile = $out.d
  command = gcc -I . -MMD -MF $out.d -std=c99 -pedantic -Wall -Werror -O0 -gdwarf-3 -ggdb -c -o $out $in

rule ld
  description = ld $in
  command = gcc -std=c99 -pedantic -Wall -Werror -O0 -gdwarf-3 -ggdb -o $out $in -lgc

rule run
  command = $in > $out

rule testmal
  description = testmal $in
  command = ./out/fblc --expect-error $in 2> $out || (cat $out ; false)

rule diff
  command = diff $in > $out

build out/FblcMain.o: cc fblc/FblcMain.c
build out/FblcEvaluator.o: cc fblc/FblcEvaluator.c
build out/FblcProgram.o: cc fblc/FblcProgram.c
build out/FblcParser.o: cc fblc/FblcParser.c
build out/FblcTokenizer.o: cc fblc/FblcTokenizer.c

build out/fblc: ld $
  out/FblcMain.o $
  out/FblcEvaluator.o $
  out/FblcProgram.o $
  out/FblcParser.o $
  out/FblcTokenizer.o $

build out/test/basic.got: run out/fblc test/basic.fblc
build out/test/basic.passed: diff out/test/basic.got test/basic.wnt

#build out/test/malformed/bad-assign-type.result: testmal test/malformed/bad-assign-type.fblc | out/fblc
#build out/test/malformed/basic.result: testmal test/malformed/basic.fblc | out/fblc
#build out/test/malformed/duplicate-struct-field.result: testmal test/malformed/duplicate-struct-field.fblc | out/fblc
#build out/test/malformed/inconsistent-cond-type.result: testmal test/malformed/inconsistent-cond-type.fblc | out/fblc
#build out/test/malformed/no-such-field.result: testmal test/malformed/no-such-field.fblc | out/fblc
#build out/test/malformed/no-such-func.result: testmal test/malformed/no-such-func.fblc | out/fblc
#build out/test/malformed/no-such-tag.result: testmal test/malformed/no-such-tag.fblc | out/fblc
#build out/test/malformed/no-such-type.result: testmal test/malformed/no-such-type.fblc | out/fblc
#build out/test/malformed/no-such-var.result: testmal test/malformed/no-such-var.fblc | out/fblc
#build out/test/malformed/too-few-cond-args.result: testmal test/malformed/too-few-cond-args.fblc | out/fblc
#build out/test/malformed/too-few-func-args.result: testmal test/malformed/too-few-func-args.fblc | out/fblc
#build out/test/malformed/too-few-struct-args.result: testmal test/malformed/too-few-struct-args.fblc | out/fblc
#build out/test/malformed/too-few-union-args.result: testmal test/malformed/too-few-union-args.fblc | out/fblc
#build out/test/malformed/too-many-cond-args.result: testmal test/malformed/too-many-cond-args.fblc | out/fblc
#build out/test/malformed/too-many-func-args.result: testmal test/malformed/too-many-func-args.fblc | out/fblc
#build out/test/malformed/too-many-struct-args.result: testmal test/malformed/too-many-struct-args.fblc | out/fblc
#build out/test/malformed/too-many-union-args.result: testmal test/malformed/too-many-union-args.fblc | out/fblc
#build out/test/malformed/var-shadow-arg.result: testmal test/malformed/var-shadow-arg.fblc | out/fblc
#build out/test/malformed/var-shadow-var.result: testmal test/malformed/var-shadow-var.fblc | out/fblc
#build out/test/malformed/wrong-type-cond-select.result: testmal test/malformed/wrong-type-cond-select.fblc | out/fblc
#build out/test/malformed/wrong-type-func-args.result: testmal test/malformed/wrong-type-func-args.fblc | out/fblc
#build out/test/malformed/wrong-type-struct-args.result: testmal test/malformed/wrong-type-struct-args.fblc | out/fblc
#build out/test/malformed/wrong-type-union-args.result: testmal test/malformed/wrong-type-union-args.fblc | out/fblc
